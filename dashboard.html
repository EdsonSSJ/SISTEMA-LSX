<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; display: none; }
        .kpi-card { @apply bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg text-center; }
        .kpi-title { @apply text-sm font-medium text-gray-500 dark:text-gray-400 uppercase; }
        .kpi-value { @apply mt-1 text-3xl font-semibold text-gray-900 dark:text-white; }
    </style>
    <script>
        // COLE O SEU OBJETO firebaseConfig AQUI
        const firebaseConfig = {
          apiKey: "FIREBASE_API_KEY",
          authDomain: "FIREBASE_AUTH_DOMAIN",
          projectId: "FIREBASE_PROJECT_ID",
          storageBucket: "FIREBASE_STORAGE_BUCKET",
          messagingSenderId: "FIREBASE_MESSAGING_SENDER_ID",
          appId: "FIREBASE_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);

        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                document.body.style.display = 'block';
                fetchDashboardData();
            } else {
                const newUrl = window.location.href.replace(/[^/]*$/, 'login.html');
                window.location.href = newUrl;
            }
        });

        google.charts.load('current', {'packages':['corechart', 'table']});
        google.charts.setOnLoadCallback(fetchDashboardData);

        function formatCurrency(value) {
            return parseFloat(value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function fetchDashboardData() {
            if (!firebase.auth().currentUser) return; // Não busca os dados antes do login ser confirmado

            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwYrYqP7HI-SBlYLsCPegvlguHX5lVmKgaLGf1L7nIsqlJcpVOeXXnSW1PZPF53rtVW/exec";
            document.getElementById('loader').style.display = 'block';

            fetch(SCRIPT_URL + "?action=getDashboardData")
                .then(response => response.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    
                    drawKPIs(data.kpis);
                    drawMonthlyChart(data.monthlyData);
                    drawExpenseChart(data.expenseData);

                    document.getElementById('loader').style.display = 'none';
                })
                .catch(error => {
                    const loader = document.getElementById('loader');
                    loader.textContent = `Erro ao carregar dados do dashboard: ${error.message}`;
                    console.error('Erro:', error);
                });
        }

        function drawKPIs(kpis) {
            document.getElementById('kpi-receitas').textContent = formatCurrency(kpis.totalReceitas);
            document.getElementById('kpi-despesas').textContent = formatCurrency(kpis.totalDespesas);
            const saldoElement = document.getElementById('kpi-saldo');
            saldoElement.textContent = formatCurrency(kpis.saldo);
            saldoElement.classList.toggle('text-red-500', kpis.saldo < 0);
            saldoElement.classList.toggle('text-green-500', kpis.saldo >= 0);
        }

        function drawMonthlyChart(monthlyData) {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Mês');
            data.addColumn('number', 'Receitas');
            data.addColumn('number', 'Despesas');
            data.addRows(monthlyData);

            const options = {
                title: 'Receitas vs. Despesas por Mês',
                titleTextStyle: { color: '#4b5563', fontSize: 16 },
                legend: { position: 'top', textStyle: { color: '#4b5563' } },
                hAxis: { textStyle: { color: '#4b5563' } },
                vAxis: { 
                    format: 'R$ #,##0.00',
                    textStyle: { color: '#4b5563' } 
                },
                colors: ['#10b981', '#ef4444'], // green, red
                backgroundColor: 'transparent',
                chartArea: {width: '85%', height: '70%'}
            };

            const chart = new google.visualization.ColumnChart(document.getElementById('monthly_chart'));
            chart.draw(data, options);
        }

        function drawExpenseChart(expenseData) {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Categoria');
            data.addColumn('number', 'Valor');
            data.addRows(expenseData);

            const options = {
                title: 'Composição das Despesas',
                titleTextStyle: { color: '#4b5563', fontSize: 16 },
                legend: { position: 'right', textStyle: { color: '#4b5563' } },
                pieHole: 0.4,
                backgroundColor: 'transparent',
                chartArea: {width: '90%', height: '80%'}
            };

            const chart = new google.visualization.PieChart(document.getElementById('expense_chart'));
            chart.draw(data, options);
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-sky-600 dark:text-sky-400">Dashboard Financeiro</h1>
        </header>

        <div id="loader" class="text-center text-gray-500 dark:text-gray-400 mb-8">Carregando dashboard...</div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="kpi-card">
                <h2 class="kpi-title">Total de Receitas</h2>
                <p id="kpi-receitas" class="kpi-value text-green-500">R$ 0,00</p>
            </div>
            <div class="kpi-card">
                <h2 class="kpi-title">Total de Despesas</h2>
                <p id="kpi-despesas" class="kpi-value text-red-500">R$ 0,00</p>
            </div>
            <div class="kpi-card">
                <h2 class="kpi-title">Saldo Atual</h2>
                <p id="kpi-saldo" class="kpi-value">R$ 0,00</p>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            <div class="lg:col-span-3 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <div id="monthly_chart" style="width: 100%; height: 400px;"></div>
            </div>
            <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <div id="expense_chart" style="width: 100%; height: 400px;"></div>
            </div>
        </div>

        <div class="mt-8 text-center">
             <a href="index.html" class="text-sky-600 hover:text-sky-700 dark:text-sky-400 dark:hover:text-sky-300 transition-colors">&larr; Voltar ao Menu Principal</a>
        </div>
    </div>
</body>
</html>
